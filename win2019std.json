{
  "variables": {
    "var_vsphere_vcenter":      "{{env `VSPHEREVCENTER`}}",
    "var_vsphere_username":     "{{env `VSPHEREUSER`}}",
    "var_vsphere_password":     "{{env `VSPHEREPASS`}}",
    "var_vsphere_datacenter":   "{{env `VSPHEREDATACENTER`}}",
    "var_vsphere_cluster":      "{{env `VSPHERECLUSTER`}}",
    "var_vsphere_datastore":    "{{env `VSPHEREDATASTORE`}}",
    "var_vsphere_network":      "{{env `VSPHERENETWORK`}}",
    "var_vsphere_folder":       "Templates/Windows",
    "var_vsphere_iso_ds":       "{{env `VSPHEREISODS`}}",
    "var_iso_path":             "os/microsoft/server/2019",
    "var_iso_file":             "en_windows_server_2019_updated_june_2020_x64_dvd_7757177c.iso",
    "var_guest_username":       "administrator",
    "var_guest_password":       "{{env `WINDOWSPASS`}}",
    "var_build_version":        "{{env `BUILDVERSION`}}",
    "var_build_repo":           "{{env `BUILDREPO`}}",
    "var_build_branch":         "{{env `BUILDBRANCH`}}",
    "var_http_server":          "{{env `HTTPSERVER`}}"
  },
  
  "builders": [
    {
      "type":                   "vsphere-iso",
      "name":                   "win2019std",
    
      "vcenter_server":         "{{user `var_vsphere_vcenter`}}",
      "username":               "{{user `var_vsphere_username`}}",
      "password":               "{{user `var_vsphere_password`}}",
      "insecure_connection":    true,
    
      "datacenter":             "{{user `var_vsphere_datacenter`}}",
      "cluster":                "{{user `var_vsphere_cluster`}}",
      "folder":                 "{{user `var_vsphere_folder`}}",
      "datastore":              "{{user `var_vsphere_datastore`}}",
      "convert_to_template":    true,
    
      "vm_name":                "ws2019std-{{user `var_build_version`}}",
      "guest_os_type":          "windows9Server64Guest",
      "CPUs":                   1,
      "RAM":                    4096,
      "disk_controller_type":   "pvscsi",
      "storage": [
        {
          "disk_size":          51200,
          "disk_thin_provisioned": true
        }
      ],
      "network_adapters": [
        {
          "network":            "{{user `var_vsphere_network`}}",
          "network_card":       "vmxnet3"
        }
      ],
      "notes":                  "VER: {{user `var_build_version`}}\nSRC: {{user `var_build_repo`}} ({{user `var_build_branch`}})\nOS: WIN2019STD\nISO: {{user `var_iso_file`}}",
    
      "communicator":           "winrm",
      "winrm_username":         "{{user `var_guest_username`}}",
      "winrm_password":         "{{user `var_guest_password`}}",
    
      "iso_paths": [
                                "{{user `var_vsphere_iso_ds`}} {{user `var_iso_path`}}/{{user `var_iso_file`}}",
                                "[] /vmimages/tools-isoimages/windows.iso"
      ],
      "shutdown_command":       "shutdown /s /t 10 /f /d p:4:1 /c Packer_Provisioning_Shutdown",
      "floppy_files": [
                                "./config/2019/STANDARD/Autounattend.xml",
                                "./scripts/windows/install-vmtools64.cmd",
                                "./scripts/windows/00-2019config.ps1"
      ]
    },
      
    {
      "type":                   "vsphere-iso",
      "name":                   "win2019stdcore",
    
      "vcenter_server":         "{{user `var_vsphere_vcenter`}}",
      "username":               "{{user `var_vsphere_username`}}",
      "password":               "{{user `var_vsphere_password`}}",
      "insecure_connection":    true,
    
      "datacenter":             "{{user `var_vsphere_datacenter`}}",
      "cluster":                "{{user `var_vsphere_cluster`}}",
      "folder":                 "{{user `var_vsphere_folder`}}",
      "datastore":              "{{user `var_vsphere_datastore`}}",
      "convert_to_template":    true,
    
      "vm_name":                "wc2019std-{{user `var_build_version`}}",
      "guest_os_type":          "windows9Server64Guest",
      "CPUs":                   1,
      "RAM":                    4096,
      "disk_controller_type":   "pvscsi",
      "storage": [
        {
          "disk_size":          51200,
          "disk_thin_provisioned": true
        }
      ],
      "network_adapters": [
        {
          "network":            "{{user `var_vsphere_network`}}",
          "network_card":       "vmxnet3"
        }
      ],
      "notes":                  "VER: {{user `var_build_version`}}\nSRC: {{user `var_build_repo`}} ({{user `var_build_branch`}})\nOS: WIN2019STDCORE\nISO: {{user `var_iso_file`}}",
    
      "communicator":           "winrm",
      "winrm_username":         "{{user `var_guest_username`}}",
      "winrm_password":         "{{user `var_guest_password`}}",
    
      "iso_paths": [
                                "{{user `var_vsphere_iso_ds`}} {{user `var_iso_path`}}/{{user `var_iso_file`}}",
                                "[] /vmimages/tools-isoimages/windows.iso"
      ],
      "shutdown_command":       "shutdown /s /t 10 /f /d p:4:1 /c Packer_Provisioning_Shutdown",
      "shutdown_timeout":       "15m",
      "floppy_files": [
                                "./config/2019/STANDARDCORE/Autounattend.xml",
                                "./scripts/windows/install-vmtools64.cmd",
                                "./scripts/windows/00-2019config.ps1"
      ]
    }
  ],

  "provisioners": [
    {
      "type":                   "powershell",
      "scripts":                ["./scripts/windows/70-2019config.ps1"]
    },
    {
      "type":                   "windows-restart",
      "restart_timeout":        "60m"
    },
    {
      "type":                   "windows-update",
      "search_criteria":        "IsInstalled=0",
      "filters": [
                                "exclude:$_.Title -like '*Preview*'",
                                "include:$true"
      ],
      "restart_timeout":        "120m"
    }
  ],

  "post-processors": [
    {
        "type": "manifest",
        "output": "win2019std-output.json",
        "strip_path": false
    }
  ]
}