{
  "variables": {
    "var_vsphere_vcenter":      "{{env `VSPHERE_VCENTER`}}",
    "var_vsphere_username":     "{{env `VSPHERE_USERNAME`}}",
    "var_vsphere_password":     "{{env `VSPHERE_PASSWORD`}}",
    "var_vsphere_datacenter":   "{{env `VSPHERE_DATACENTER`}}",
    "var_vsphere_cluster":      "{{env `VSPHERE_CLUSTER`}}",
    "var_vsphere_datastore":    "{{env `VSPHERE_DATASTORE`}}",
    "var_vsphere_network":      "{{env `VSPHERE_NETWORK`}}",
    "var_vsphere_folder":       "{{env `VSPHERE_FOLDER`}}",
    "var_vsphere_iso_ds":       "{{env `VSPHERE_ISO_DS`}}",
    "var_iso_path":             "{{env `ISO_PATH`}}",
    "var_iso_file":             "{{env `ISO_FILE`}}",
    "var_guest_username":       "{{env `GUEST_USERNAME`}}",
    "var_guest_password":       "{{env `GUEST_PASSWORD`}}"
  },
  
  "builders": [
    {
      "type":                   "vsphere-iso",
      "name":                   "WindowsServer2016-STANDARD",
    
      "vcenter_server":         "{{user `var_vsphere_vcenter`}}",
      "username":               "{{user `var_vsphere_username`}}",
      "password":               "{{user `var_vsphere_password`}}",
      "insecure_connection":    true,
    
      "datacenter":             "{{user `var_vsphere_datacenter`}}",
      "cluster":                "{{user `var_vsphere_cluster`}}",
      "folder":                 "{{user `var_vsphere_folder`}}",
      "datastore":              "{{user `var_vsphere_datastore`}}",
      "convert_to_template":    true,
    
      "vm_name":                "ws2016-{{isotime \"20060102_1504\"}}",
      "guest_os_type":          "windows9Server64Guest",
      "CPUs":                   1,
      "RAM":                    4096,
      "disk_controller_type":   "pvscsi",
      "storage": [
        {
          "disk_size":          51200,
          "disk_thin_provisioned": true
        }
      ],
      "network_adapters": [
        {
          "network":            "{{user `var_vsphere_network`}}",
          "network_card":       "vmxnet3"
        }
      ],
      "notes":                  "BUILDDATE: {{isotime \"20060102_1504\"}} || BUILDOS: Windows Server 2016 Standard || BUILDISO: {{user `var_iso_file`}}",
    
      "communicator":           "winrm",
      "winrm_username":         "{{user `var_guest_username`}}",
      "winrm_password":         "{{user `var_guest_password`}}",
    
      "iso_paths": [
                                "{{user `var_vsphere_iso_ds`}} {{user `var_iso_path`}}/{{user `var_iso_file`}}",
                                "[] /vmimages/tools-isoimages/windows.iso"
      ],
      "shutdown_command":       "shutdown /s /t 10 /f /d p:4:1 /c Packer_Provisioning_Shutdown",
      "floppy_files": [
                                "./2016/STANDARD/Autounattend.xml",
                                "./scripts/install-vmtools64.cmd",
                                "./scripts/phase1-config.ps1"
      ]
    },
      
    {
      "type":                   "vsphere-iso",
      "name":                   "WindowsServer2016-STANDARDCORE",
    
      "vcenter_server":         "{{user `var_vsphere_vcenter`}}",
      "username":               "{{user `var_vsphere_username`}}",
      "password":               "{{user `var_vsphere_password`}}",
      "insecure_connection":    true,
    
      "datacenter":             "{{user `var_vsphere_datacenter`}}",
      "cluster":                "{{user `var_vsphere_cluster`}}",
      "folder":                 "{{user `var_vsphere_folder`}}",
      "datastore":              "{{user `var_vsphere_datastore`}}",
      "convert_to_template":    true,
    
      "vm_name":                "wc2016-{{isotime \"20060102_1504\"}}",
      "guest_os_type":          "windows9Server64Guest",
      "CPUs":                   1,
      "RAM":                    4096,
      "disk_controller_type":   "pvscsi",
      "storage": [
        {
          "disk_size":          51200,
          "disk_thin_provisioned": true
        }
      ],
      "network_adapters": [
        {
          "network":            "{{user `var_vsphere_network`}}",
          "network_card":       "vmxnet3"
        }
      ],
      "notes":                  "BUILDDATE: {{isotime \"20060102_1504\"}} || BUILDOS: Windows Server 2016 Standard Core || BUILDISO: {{user `var_iso_file`}}",
    
      "communicator":           "winrm",
      "winrm_username":         "{{user `var_guest_username`}}",
      "winrm_password":         "{{user `var_guest_password`}}",
    
      "iso_paths": [
                                "{{user `var_vsphere_iso_ds`}} {{user `var_iso_path`}}/{{user `var_iso_file`}}",
                                "[] /vmimages/tools-isoimages/windows.iso"
      ],
      "shutdown_command":       "shutdown /s /t 10 /f /d p:4:1 /c Packer_Provisioning_Shutdown",
      "shutdown_timeout":       "15m",
      "floppy_files": [
                                "./2016/STANDARDCORE/Autounattend.xml",
                                "./scripts/install-vmtools64.cmd",
                                "./scripts/phase1-config.ps1"
      ]
    }
  ],

  "provisioners": [
    {
      "type":                   "powershell",
      "scripts":                ["./scripts/phase2-config.ps1"]
    },
    {
      "type":                   "windows-restart",
      "restart_timeout":        "60m"
    },
    {
      "type":                   "windows-update",
      "search_criteria":        "IsInstalled=0",
      "filters": [
                                "exclude:$_.Title -like '*Preview*'",
                                "include:$true"
      ],
      "restart_timeout":        "120m"
    }
  ],

  "post-processors": [
    {
        "type": "manifest",
        "output": "windows2016-vsphere_output.json",
        "strip_path": false
    }
  ]
}